{
  "meta": {
    "project": "KL Beton Payroll & Attendance System",
    "date": "2026-02-15",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "KL Beton is an automated payroll and attendance system for construction workforce management, handling daily attendance, overtime, leave balances, and salary advances with role-based access controls. The backend exposes APIs for authentication, employee CRUD, attendance (pointage), advances, statistics, messaging, and report exports.",
  "core_goals": [
    "Provide secure role-based authentication (ADMIN, CHEF, EMPLOYE) and inject role metadata into session/JWT.",
    "Accurately track daily attendance, overtime and enforce leave balance decrements for validated leave records.",
    "Compute payroll using the 26-day month logic (daily/hourly/overtime rates) and deduct only APPROVED advances.",
    "Support two-step approval workflows for financial advances and admin-only actions.",
    "Expose aggregated statistics and chart-ready datasets for dashboard visualization.",
    "Enable internal messaging and exporting of monthly attendance/payroll reports as PDFs.",
    "Enforce RBAC, prevent duplicate attendance records, and handle edge cases (zero worked days, negative net salary)."
  ],
  "features": [
    {
      "name": "Authentication",
      "description": "Authenticate Admins, Chefs and Employees using NextAuth credentials provider; inject role, nom, prenom into JWT and session; prevent invalid logins.",
      "user_flows": [
        "POST /api/auth/[...nextauth] with valid admin credentials {email, password} -> Receive 200 with JWT/session containing role: ADMIN, nom, prenom",
        "POST /api/auth/[...nextauth] with valid employee credentials {email, password} -> Receive 200 with JWT/session containing role: EMPLOYE, nom, prenom",
        "POST /api/auth/[...nextauth] with invalid credentials {email, wrongPassword} -> Receive 401 Unauthorized and error message (login prevented)",
        "GET /api/dashboard/stats?startDate=2026-02-01&endDate=2026-02-15 with Authorization: Bearer <ADMIN_JWT> -> Receive 200 with aggregated stats (Admin allowed)",
        "GET /api/dashboard/stats?startDate=2026-02-01&endDate=2026-02-15 with Authorization: Bearer <EMPLOYE_JWT> -> Receive 403 Forbidden (RBAC enforcement)"
      ]
    },
    {
      "name": "Employee Management",
      "description": "CRUD operations for employees (personal data, role, salary, leave balances). Admins manage the workforce; employees can fetch their own profile.",
      "user_flows": [
        "POST /api/employes with Authorization: Bearer <ADMIN_JWT> and body {nom, prenom, salary, role, hireDate, leaveBalances} -> Receive 201 Created with employee record",
        "GET /api/employes with Authorization: Bearer <ADMIN_JWT> -> Receive 200 with list of employees",
        "GET /api/employes/[id] with Authorization: Bearer <ADMIN_JWT> -> Receive 200 with employee details",
        "GET /api/employes/[id] with Authorization: Bearer <EMPLOYE_JWT> where id != employee's own id -> Receive 403 Forbidden (data isolation)",
        "PATCH /api/employes/[id] with Authorization: Bearer <ADMIN_JWT> and body {salary: newSalary} -> Receive 200 with updated employee",
        "PATCH /api/employes/[id] with Authorization: Bearer <EMPLOYE_JWT> to update another employee -> Receive 403 Forbidden",
        "DELETE /api/employes/[id] with Authorization: Bearer <ADMIN_JWT> -> Receive 204 No Content",
        "POST /api/employes with missing required fields and Authorization: Bearer <ADMIN_JWT> -> Receive 400 Bad Request with validation errors"
      ]
    },
    {
      "name": "Attendance (Pointage)",
      "description": "Bulk and individual attendance recording (PRESENT, ABSENT, CONGE, MALADIE, FERIE) with overtime hours; CHEF role can bulk-insert for a date and patch historical records for corrections.",
      "user_flows": [
        "POST /api/pointages with Authorization: Bearer <CHEF_JWT> and body {date: \"2026-02-10\", entries: [{employeeId, status: \"PRESENT\", overtimeHours: 2}, ...]} -> Receive 201 Created with inserted records",
        "GET /api/pointages?date=2026-02-10 with Authorization: Bearer <CHEF_JWT> -> Receive 200 with attendance records for that date",
        "PATCH /api/pointages with Authorization: Bearer <CHEF_JWT> and body {recordId, status: \"CONGE\"} -> Receive 200 with updated record and employee leave balance decremented by 1",
        "POST /api/pointages with Authorization: Bearer <EMPLOYE_JWT> (EMPLOYE attempts bulk insert) -> Receive 403 Forbidden (only CHEF allowed)",
        "POST /api/pointages with Authorization: Bearer <CHEF_JWT> where a record for employeeId and date already exists -> Receive 409 Conflict (duplicate attendance prevented)",
        "PATCH /api/pointages with Authorization: Bearer <CHEF_JWT> to set status to MALADIE for an old record -> Receive 200 and employee sickness leave balance decremented by 1"
      ]
    },
    {
      "name": "Salary Advances (Finance)",
      "description": "Employees can request salary advances; Admins approve/reject advances. Only APPROVED advances are deducted from payroll calculations.",
      "user_flows": [
        "POST /api/avances with Authorization: Bearer <EMPLOYE_JWT> and body {employeeId, amount, date} -> Receive 201 Created with status: PENDING",
        "GET /api/avances?status=PENDING with Authorization: Bearer <ADMIN_JWT> -> Receive 200 with list of pending advances",
        "PATCH /api/avances/[id] with Authorization: Bearer <ADMIN_JWT> and body {status: \"APPROVED\"} -> Receive 200 with status: APPROVED",
        "PATCH /api/avances/[id] with Authorization: Bearer <CHEF_JWT> and body {status: \"APPROVED\"} -> Receive 403 Forbidden (only ADMIN can change status)",
        "GET /api/avances?status=APPROVED with Authorization: Bearer <ADMIN_JWT> -> Receive 200 with approved advances included in payroll deductions",
        "POST /api/avances with Authorization: Bearer <EMPLOYE_JWT> and negative amount -> Receive 400 Bad Request (validation error)"
      ]
    },
    {
      "name": "Dashboard Statistics",
      "description": "Provide aggregated admin statistics (total employees, present today, total approved advances, total overtime) and chart-ready data grouped by employee.",
      "user_flows": [
        "GET /api/dashboard/stats?startDate=2026-02-01&endDate=2026-02-28 with Authorization: Bearer <ADMIN_JWT> -> Receive 200 with {totalEmployees, totalPresences, totalOvertimeHours, totalApprovedAdvances, overtimeByEmployee: [{name, hours}, ...]} suitable for Chart.js",
        "GET /api/dashboard/stats?startDate=2026-02-01&endDate=2026-02-28 with Authorization: Bearer <CHEF_JWT> -> Receive 200 with aggregated stats (Chef allowed where permitted by RBAC)",
        "GET /api/dashboard/stats without startDate/endDate with Authorization: Bearer <ADMIN_JWT> -> Receive 400 Bad Request (date range required)",
        "GET /api/dashboard/stats?startDate=2026-02-01&endDate=2026-02-28 with Authorization: Bearer <EMPLOYE_JWT> -> Receive 403 Forbidden (non-admin data access restricted)"
      ]
    },
    {
      "name": "Messaging",
      "description": "Internal messaging between users with unread counts and chat contact lists.",
      "user_flows": [
        "POST /api/messages with Authorization: Bearer <EMPLOYE_JWT> and body {toUserId, content} -> Receive 201 Created with message record",
        "GET /api/messages/unread with Authorization: Bearer <EMPLOYE_JWT> -> Receive 200 with list of unread messages and counts",
        "GET /api/users/chat-contacts with Authorization: Bearer <EMPLOYE_JWT> -> Receive 200 with list of chat contacts and last message previews",
        "POST /api/messages with Authorization: missing or invalid token -> Receive 401 Unauthorized",
        "POST /api/messages with Authorization: Bearer <EMPLOYE_JWT> and toUserId that does not exist -> Receive 404 Not Found"
      ]
    },
    {
      "name": "Reports & Exports",
      "description": "Generate monthly attendance and payroll reports with PDF export for admin consumption.",
      "user_flows": [
        "POST /api/rapports/generate with Authorization: Bearer <ADMIN_JWT> and body {month: \"2026-02\", type: \"payroll\"} -> Receive 200 with {reportId, downloadUrl} and PDF available at downloadUrl",
        "GET /api/rapports/[reportId]/download with Authorization: Bearer <ADMIN_JWT> -> Receive 200 with application/pdf stream",
        "POST /api/rapports/generate with Authorization: Bearer <EMPLOYE_JWT> -> Receive 403 Forbidden (only ADMIN allowed)",
        "POST /api/rapports/generate with Authorization: Bearer <ADMIN_JWT> and invalid month format -> Receive 400 Bad Request (validation error)"
      ]
    }
  ],
  "code_summary": {
    "tech_stack": [
      "JavaScript",
      "Next.js",
      "React",
      "Tailwind CSS",
      "Prisma",
      "PostgreSQL",
      "NextAuth.js",
      "Framer Motion",
      "Lucide React"
    ],
    "features": [
      {
        "name": "Authentication",
        "description": "Handles user login for Admins and Employees using NextAuth.js with Credentials provider.",
        "files": [
          "app/api/auth/[...nextauth]/route.js",
          "app/(auth)/login-admin/page.js",
          "app/(auth)/employee-login/page.js"
        ]
      },
      {
        "name": "Employee Management",
        "description": "CRUD operations for managing employees, including personal details, roles (Admin, Chef, Employee), and salary info.",
        "files": [
          "app/api/employes/route.js",
          "app/api/employes/[id]/route.js",
          "app/(dashboard)/(admin)/admin/dashboard/employes/page.js",
          "app/(dashboard)/(admin)/admin/dashboard/employes/[id]/page.js"
        ]
      },
      {
        "name": "Attendance (Pointage)",
        "description": "Tracking daily attendance (Présent, Absent, Congé,etc.) and overtime. Accessible by Admins and Chefs.",
        "files": [
          "app/api/pointages/route.js",
          "app/(dashboard)/(admin)/admin/dashboard/pointage/page.js",
          "app/(dashboard)/(chef)/chef/pointage/page.js"
        ]
      },
      {
        "name": "Salary Advances (Finance)",
        "description": "Management of employee salary advances. Deducted from payroll.",
        "files": [
          "app/api/avances/route.js",
          "app/(dashboard)/(admin)/admin/dashboard/finances/page.js"
        ]
      },
      {
        "name": "Dashboard Statistics",
        "description": "Aggregated statistics for the Admin dashboard (total employees, present today, total advances, etc.).",
        "files": [
          "app/api/dashboard/stats/route.js",
          "app/(dashboard)/(admin)/admin/dashboard/page.js"
        ]
      },
      {
        "name": "Messaging",
        "description": "Internal messaging system between users.",
        "files": [
          "app/api/messages/route.js",
          "app/api/messages/unread/route.js",
          "app/api/users/chat-contacts/route.js",
          "app/(dashboard)/messages/page.js"
        ]
      },
      {
        "name": "Reports & Exports",
        "description": "Generating monthly attendance and payroll reports, with PDF export.",
        "files": [
          "app/(dashboard)/(admin)/admin/dashboard/rapports/page.js"
        ]
      }
    ]
  }
}
